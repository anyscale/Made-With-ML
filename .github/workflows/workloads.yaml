name: workloads
on:
  workflow_dispatch:  # triggered manually
  pull_request:
    branches:
    - main  # triggered on PRs to the main branch

jobs:
  set-up:
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/setup.yaml

  evaluate-model:
    runs-on: ubuntu-22.04
    steps:

      # Test code + data
      - name: Train code + data
        run: |
          echo "Testing code + data"
          echo ${{ env.GITHUB_USERNAME }}
          echo ${{ env.COMMIT_ID }}
          echo $(anyscale project list --created-by-me)

      # Train our model (could also tune)
      - name: Train model
        run: |
          echo "Training model"
          echo ${{ env.GITHUB_USERNAME }}
          echo ${{ env.COMMIT_ID }}
          echo $(pip freeze)

      # Get run ID
      - name: Get run ID
        run: |
          echo "Run ID:"

      # Evaluate our model
      - name: Evaluate model
        run: |
          python deploy/app.py submit-job \
            --yaml-config-fp deploy/jobs/evaluate.yaml \
            --cluster-env-name ${{ env.CLUSTER_ENV_NAME }} \
            --run-id "" \
            --commit-id ${{ env.COMMIT_ID }}
      - name: Read results from S3
        run: aws s3 cp ${{ env.S3_BUCKET }}/${{ env.GITHUB_USERNAME }}/results/${{ env.COMMIT_ID }}/evaluation_results.json evaluation_results.json
      - name: Comment results on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs')
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: fs.readFileSync('evaluation_results.json', 'utf8')
            })

      # Test model
      - name: Test model
        run: echo "Test model"